<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ç™ºè¡¨è€…ç”»é¢ â€” ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ‘ãƒ¼</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@900&display=swap');

  :root {
    --bg: #080f14;
    --surface: #0e1c27;
    --accent: #00d4ff;
    --accent-dim: rgba(0,212,255,0.15);
    --over: #ff4d4d;
    --over-dim: rgba(255,77,77,0.15);
    --success: #4dff91;
    --text: #e8f4f8;
    --muted: #2a4a5a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%; height: 100%;
    background: var(--bg);
    overflow: hidden;
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Share Tech Mono', monospace;
    position: relative;
  }

  /* èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰æ¼”å‡º */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .screen {
    position: relative;
    z-index: 1;
    text-align: center;
    width: 100%;
    padding: 20px;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ« */
  .status-label {
    font-size: clamp(1.2rem, 3.5vw, 2rem);
    letter-spacing: 0.25em;
    color: var(--muted);
    margin-bottom: 16px;
    transition: color 0.5s;
    text-transform: uppercase;
  }
  .status-label.active { color: var(--accent); }
  .status-label.over { color: var(--over); }
  .status-label.paused { color: #ffaa33; }

  /* ãƒ¡ã‚¤ãƒ³æ•°å­— */
  .time-wrap {
    position: relative;
    display: inline-flex;
    align-items: baseline;
    gap: 0.08em;
  }

  .digits {
    font-size: clamp(18vw, 22vw, 280px);
    font-weight: 900;
    color: var(--accent);
    line-height: 1;
    letter-spacing: -0.02em;
    transition: color 0.4s;
    font-family: 'Share Tech Mono', monospace;
    /* ãƒ†ã‚­ã‚¹ãƒˆã®ç¸å–ã‚Š */
    text-shadow:
      0 0 60px rgba(0,212,255,0.4),
      0 0 120px rgba(0,212,255,0.15);
  }
  .digits.over {
    color: var(--over);
    text-shadow:
      0 0 60px rgba(255,77,77,0.5),
      0 0 120px rgba(255,77,77,0.2);
  }
  .digits.paused { opacity: 0.6; }

  /* å˜ä½ãƒ©ãƒ™ãƒ« */
  .unit {
    font-size: clamp(2.5vw, 4vw, 56px);
    color: var(--muted);
    letter-spacing: 0.1em;
    line-height: 1;
    align-self: flex-end;
    padding-bottom: 0.18em;
  }

  /* ãƒ™ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ (é³´ã£ãŸæ™‚ã«ã‚¢ãƒ‹ãƒ¡) */
  .bell-icon {
    font-size: clamp(2rem, 5vw, 4rem);
    position: absolute;
    top: -40px;
    right: -60px;
    opacity: 0;
    transform: scale(0.5) rotate(-20deg);
    transition: all 0.2s;
    pointer-events: none;
  }
  .bell-icon.ring {
    animation: bellRing 0.8s ease forwards;
  }
  @keyframes bellRing {
    0%  { opacity: 0; transform: scale(0.5) rotate(-20deg); }
    30% { opacity: 1; transform: scale(1.3) rotate(15deg); }
    60% { transform: scale(1.1) rotate(-10deg); }
    100%{ opacity: 0; transform: scale(1) rotate(0deg); }
  }

  /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
  .progress-wrap {
    width: min(80vw, 640px);
    height: 6px;
    background: var(--accent-dim);
    border-radius: 3px;
    margin: 24px auto 0;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 0.3s linear, background 0.4s;
    width: 100%;
  }
  .progress-bar.over { background: var(--over); }

  /* ãƒ™ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
  .bell-indicators {
    display: flex;
    justify-content: center;
    gap: clamp(12px, 3vw, 40px);
    margin-top: 28px;
  }
  .bell-dot {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  .bell-dot-circle {
    width: clamp(12px, 2vw, 20px);
    height: clamp(12px, 2vw, 20px);
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s, box-shadow 0.3s;
  }
  .bell-dot-circle.enabled { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
  .bell-dot-circle.triggered { background: var(--success); box-shadow: 0 0 10px var(--success); }
  .bell-dot-circle.disabled { background: var(--muted); opacity: 0.3; }
  .bell-dot-label {
    font-size: clamp(0.55rem, 1.2vw, 0.8rem);
    color: var(--muted);
    letter-spacing: 0.05em;
  }

  /* æ¥ç¶šçŠ¶æ…‹ */
  .conn-status {
    position: fixed;
    bottom: 16px;
    right: 20px;
    font-size: 0.75rem;
    color: var(--muted);
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .conn-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s;
  }
  .conn-dot.ok { background: var(--success); box-shadow: 0 0 6px var(--success); }

  /* å…¨ç”»é¢ãƒœã‚¿ãƒ³ */
  .fullscreen-btn {
    position: fixed;
    top: 14px;
    right: 16px;
    background: none;
    border: 1px solid var(--muted);
    color: var(--muted);
    font-size: 0.75rem;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 10;
    font-family: 'Share Tech Mono', monospace;
    transition: all 0.2s;
  }
  .fullscreen-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ™ãƒ«æ™‚ï¼‰ */
  .flash {
    position: fixed;
    inset: 0;
    background: rgba(0,212,255,0.08);
    pointer-events: none;
    opacity: 0;
    z-index: 50;
  }
  .flash.show {
    animation: flashAnim 0.4s ease forwards;
  }
  @keyframes flashAnim {
    0% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* PAUSED ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  .paused-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(8,15,20,0.6);
    z-index: 40;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s;
  }
  .paused-overlay.show { opacity: 1; }
  .paused-text {
    font-size: clamp(3rem, 10vw, 8rem);
    color: #ffaa33;
    letter-spacing: 0.2em;
    text-shadow: 0 0 40px rgba(255,170,51,0.4);
    animation: pauseBlink 1.4s ease-in-out infinite;
  }
  @keyframes pauseBlink {
    0%,100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
</style>
</head>
<body>

<div class="flash" id="flash"></div>
<div class="paused-overlay" id="paused-overlay">
  <div class="paused-text">PAUSE</div>
</div>

<button class="fullscreen-btn" onclick="toggleFS()">â›¶ å…¨ç”»é¢</button>

<div class="screen">
  <div class="status-label" id="status-label">READY</div>

  <div class="time-wrap">
    <div class="digits" id="digits">0:00</div>
    <div class="bell-icon" id="bell-icon">ğŸ””</div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <div class="bell-indicators" id="bell-indicators">
    <div class="bell-dot">
      <div class="bell-dot-circle" id="bdot-0"></div>
      <div class="bell-dot-label" id="bdot-lbl-0">ãƒ™ãƒ«1å›</div>
    </div>
    <div class="bell-dot">
      <div class="bell-dot-circle" id="bdot-1"></div>
      <div class="bell-dot-label" id="bdot-lbl-1">ãƒ™ãƒ«2å›</div>
    </div>
    <div class="bell-dot">
      <div class="bell-dot-circle" id="bdot-2"></div>
      <div class="bell-dot-label" id="bdot-lbl-2">ãƒ™ãƒ«3å›</div>
    </div>
  </div>
</div>

<div class="conn-status">
  <div class="conn-dot" id="conn-dot"></div>
  <span id="conn-text">æ¥ç¶šä¸­...</span>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
// ============================================================
// Web Audio API â€” é«˜å“è³ªãƒ™ãƒ«éŸ³ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼
// ============================================================
let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
  return audioCtx;
}

/**
 * æ•™ä¼šãƒ»ãƒãƒ³ãƒ‰ãƒ™ãƒ«é¢¨ã®é«˜å“è³ªãƒ™ãƒ«éŸ³
 * å€éŸ³ã‚’è¤‡æ•°é‡ã­ã¦ãƒªã‚¢ãƒ«ãªãƒ™ãƒ«ã®éŸ¿ãã‚’ç”Ÿæˆ
 */
function synthesizeBell(ctx, startTime, volume = 0.7) {
  const now = startTime;

  // ãƒ™ãƒ«éŸ³ã®å€éŸ³æ§‹æˆ [å‘¨æ³¢æ•°æ¯”, æŒ¯å¹…æ¯”, æ¸›è¡°æ™‚å®šæ•°]
  const partials = [
    [1.000, 1.00, 2.0],   // åŸºéŸ³ (A4 = 440Hz)
    [2.756, 0.67, 1.5],   // çŸ­3åº¦ä¸Š
    [5.404, 0.35, 1.0],   // 3å€éŸ³ç³»
    [3.000, 0.25, 0.8],   // å®Œå…¨5åº¦
    [4.000, 0.20, 0.7],
    [5.748, 0.15, 0.6],
    [7.565, 0.08, 0.4],
  ];

  const baseFreq = 523.25; // C5

  partials.forEach(([ratio, amp, decay]) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.frequency.setValueAtTime(baseFreq * ratio, now);
    osc.type = 'sine';

    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(volume * amp, now + 0.002); // ã‚¢ã‚¿ãƒƒã‚¯
    gain.gain.exponentialRampToValueAtTime(0.001, now + decay * 3.5); // ãƒ‡ã‚£ã‚±ã‚¤

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start(now);
    osc.stop(now + decay * 4);
  });
}

/**
 * nå›ãƒ™ãƒ«ã‚’é³´ã‚‰ã™ï¼ˆgap_msé–“éš”ï¼‰
 */
function playBellN(n, gapMs = 800) {
  const ctx = getAudioCtx();
  for (let i = 0; i < n; i++) {
    synthesizeBell(ctx, ctx.currentTime + i * (gapMs / 1000));
  }
  // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  triggerBellVisual();
}

function triggerBellVisual() {
  const flash = document.getElementById('flash');
  const bellIcon = document.getElementById('bell-icon');

  flash.classList.remove('show');
  void flash.offsetWidth;
  flash.classList.add('show');

  bellIcon.classList.remove('ring');
  void bellIcon.offsetWidth;
  bellIcon.classList.add('ring');
}

// ============================================================
// Socket.IO çŠ¶æ…‹æ›´æ–°
// ============================================================
const socket = io();

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§AudioContextã‚’æœ‰åŠ¹åŒ–
document.addEventListener('click', () => { getAudioCtx(); }, { once: true });

socket.on('connect', () => {
  document.getElementById('conn-dot').classList.add('ok');
  document.getElementById('conn-text').textContent = 'æ¥ç¶šæ¸ˆã¿';
});
socket.on('disconnect', () => {
  document.getElementById('conn-dot').classList.remove('ok');
  document.getElementById('conn-text').textContent = 'å†æ¥ç¶šä¸­...';
});

socket.on('state', (s) => {
  updateDisplay(s);

  // ãƒ™ãƒ«ç™ºç«
  if (s.fire_bells && s.fire_bells.length > 0) {
    s.fire_bells.forEach(count => {
      playBellN(count, 800);
    });
  }
});

function fmtTime(sec) {
  const sign = sec < 0 ? '-' : '';
  const abs = Math.abs(Math.round(sec));
  const m = Math.floor(abs / 60);
  const ss = abs % 60;
  return `${sign}${m}:${String(ss).padStart(2,'0')}`;
}

function updateDisplay(s) {
  const digEl = document.getElementById('digits');
  const statEl = document.getElementById('status-label');
  const progEl = document.getElementById('progress-bar');
  const pauseOv = document.getElementById('paused-overlay');

  // æ•°å­—
  digEl.textContent = fmtTime(s.remaining_sec);
  digEl.classList.toggle('over', s.over);
  digEl.classList.toggle('paused', !!s.paused);

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«
  if (s.paused) {
    statEl.textContent = 'PAUSE';
    statEl.className = 'status-label paused';
    pauseOv.classList.add('show');
  } else {
    pauseOv.classList.remove('show');
    if (!s.running) {
      statEl.textContent = 'READY';
      statEl.className = 'status-label';
    } else if (s.over) {
      statEl.textContent = 'è¶…ã€€é';
      statEl.className = 'status-label over';
    } else {
      statEl.textContent = 'æ®‹ã€€ã‚Š';
      statEl.className = 'status-label active';
    }
  }

  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
  const pct = s.total_sec > 0
    ? Math.max(0, Math.min(100, (s.remaining_sec / s.total_sec) * 100))
    : 0;
  progEl.style.width = pct + '%';
  progEl.classList.toggle('over', s.over);

  // ãƒ™ãƒ«ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
  if (s.bells) {
    s.bells.forEach((b, i) => {
      const dot = document.getElementById(`bdot-${i}`);
      const lbl = document.getElementById(`bdot-lbl-${i}`);
      if (!dot) return;
      dot.className = 'bell-dot-circle';
      if (!b.enabled) {
        dot.classList.add('disabled');
      } else if (b.triggered) {
        dot.classList.add('triggered');
      } else {
        dot.classList.add('enabled');
      }
      const m = Math.floor(b.at_sec / 60);
      const ss = b.at_sec % 60;
      const timeStr = ss === 0 ? `${m}åˆ†` : `${m}:${String(ss).padStart(2,'0')}`;
      lbl.textContent = `Ã—${i+1} @ ${timeStr}`;
    });
  }
}

// å…¨ç”»é¢
function toggleFS() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(() => {});
  } else {
    document.exitFullscreen().catch(() => {});
  }
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ (ã‚¹ãƒšãƒ¼ã‚¹=å…¨ç”»é¢)
document.addEventListener('keydown', (e) => {
  if (e.code === 'KeyF' || e.code === 'F11') {
    e.preventDefault();
    toggleFS();
  }
});
</script>
</body>
</html>
